---
title: "alpha diversity"
author: "Harald Brolin"
date: "September 3, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(phyloseq); packageVersion("phyloseq")
library(ggplot2); packageVersion("ggplot2")
library(tidyverse); packageVersion("tidyverse")
library(readr)
library(gridExtra)
library(EnvStats)
library(Hmisc)
```

```{r}
df <- readRDS("../phyloseq_v2.rds") # Read the data frame
```

### Alpha-diversity 
First we ant to look at the alpha diversity for the diffent samples. Several diversity matrices exist, some highlight differnece in evenness, abundence of rare species, abundence of common species etc. This article [link]<https://www.biorxiv.org/content/biorxiv/early/2017/12/11/231878.full.pdf> states that "However, since estimates for alpha diversity metrics are heavily biased when taxa are unobserved, comparing alpha diversity using either raw or rarefied data should not be undertaken."  "While the example discussed here is richness, this approach to estimating and comparing alpha diversity using a bias correction (incorporating unobserved taxa) and a variance adjustment (measurement error model) could apply to any alpha diversity metric." The articel recommends using the Chao-Bunge measurment and the "breakaway" measurment, the article advises agains the use of **richness**. 


First we want to look at general trends across all samples:

```{r}
richness_df <- 
  estimate_richness(df,
                    split = TRUE, # Calculate for all samples an not for each group
                    measures = c("Observed", "Chao1", "Shannon", "Simpson")) # The measurments which are caluclated
richness_df <- # Merge the alpha-div measurments with metadat
  cbind(richness_df, df@sam_data)

```

```{r echo=FALSE}
plot_theme <- # Formats plot, removes axis labels and increase font size
  theme(axis.text.x = element_text(size = 12),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_blank(),
        legend.key = element_blank(),
        plot.title = element_text(hjust = 0.5))

p1 <- # Assign only to get the rmarkdown picture 
  ggplot(richness_df, aes(x = season, y = Chao1,  fill = location)) + # Plot Chao1 one bar per each location
          geom_boxplot() +
          stat_n_text() + # From EnvStat package, gives the number of samples per group
          ggtitle("Chao1 index") +
          plot_theme; p1 # Change font size and print plot

p2 <- # Assign only to get the rmarkdown picture 
  ggplot(richness_df, aes(x = season, y = Observed,  fill = location)) + # Plot observed one bar per each location
          geom_boxplot() +
          stat_n_text() + # From EnvStat package, gives the number of samples per group
          ggtitle("Observed") +
          plot_theme; p2 # Change font size and print plot

p3 <- # Assign only to get the rmarkdown picture 
  ggplot(richness_df, aes(x = season, y = Shannon,  fill = location)) + # Plot shannon one bar per each location
          geom_boxplot() +
          stat_n_text() + # From EnvStat package, gives the number of samples per group
          ggtitle("Shannon index") +
          plot_theme; p3 # Change font size and print plot

p8 <- # Assign only to get the rmarkdown picture Remove oulier Rassnas140417
  ggplot(richness_df %>% rownames_to_column() %>% filter(rowname != "Rassnas140417"), aes(x = season, y = Simpson,  fill = location)) + # Plot simpson
          geom_boxplot() +
          stat_n_text() + # From EnvStat package, gives the number of samples per group
          ggtitle("Simpson index, one outlier removed Rassnas140417") +
          plot_theme; p8 # Change font size and print plot

p4 <-  # Plot longitudinal scatter,ordered based on sampling_date
  ggplot(richness_df,aes(x = sampling_date, y = Chao1, group = season)) +
  facet_wrap(~location) + # One plot for each location
  geom_line(aes(group = location)) + # Add the line
  geom_point(aes(group = season, color = season)) + # Color points by season
  ggtitle("Chao1 index") +
  theme(axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        axis.text.x =  element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 10),
        legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5)); p4 # Formatting

p7 <-  # Plot longitudinal scatter,ordered based on sampling_date
  ggplot(richness_df,aes(x = sampling_date, y = Simpson, group = season)) +
  facet_wrap(~location) + # One plot for each location
  geom_line(aes(group = location)) + # Add the line
  geom_point(aes(group = season, color = season)) + # Color points by season
  ggtitle("Sinmpson index") +
  theme(axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        axis.text.x =  element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 10),
        legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5)); p7 # Formatting

p5 <- 
  ggplot(richness_df,aes(x = sampling_date, y = Shannon, group = season)) +
  facet_wrap(~location) +
  geom_line(aes(group = location)) +
  geom_point(aes(group = season, color = season)) +
  ggtitle("Shannon index") +
  theme(axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        axis.text.x =  element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 10),
        legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5)); p5 # Formatting


# ggsave(plot = p1, filename = "../../analysis_images/1_chao1_box.png")
# ggsave(plot = p2, filename = "../../analysis_images/1_observed_box.png")
ggsave(plot = p3, filename = "../../analysis_images/1_shannon_box.png")
ggsave(plot = p8, filename = "../../analysis_images/1_simpson_box.png")

ggsave(plot = p7, filename = "../../analysis_images/1_simpson_line.png")
ggsave(plot = p5, filename = "../../analysis_images/1_shannon_line.png")
```



**Chao1** estimates diversity from abundant data and estimates number of rare taxa missed from undersampling *Chao, A. (1984). “Non-parametric estimation of the number of classes in a population”.*  **Shannon**: Calculates richness and diversity using a natural logarithm, accounts for both abundance and evenness of the taxa present. *Shannon, C.E. and Weaver, W. (1949). “The mathematical theory of communication”. University of Illonois Press, Champaign, Illonois.*  **Fisher**: Relationship between the number of species and the abundance of each species. *Fisher, R.A., Corbet, A.S. and Williams, C.B. (1943). “The relation between the number of species and the number of individuals in a random sample of an animal population”. Journal of Animal Ecology. (12): 42-58.*

Information about the measurments, [link]<https://forum.qiime2.org/t/alpha-and-beta-diversity-explanations-and-commands/2282>

#### Conclusion
ACE, Obcerved (richnees) and Chao1 are all basically the same and thus only Chao1 is kept. 
Looking at the Chao1 value for all sites, it seems like winter samples differs the most from the rest of the samples (although the reason for this could be the low number of winter samples).  Looking at the shannon index we can see a similar pattern for all samples.


### Next we want to investigate the correaltion between depth and index

```{r}
richness_df$sample_depth <- df@otu_table %>% colSums() # Add depth to metadata, for each sample

# Scatterplot of index vs depth, to investigate correlation

p1 <- ggplot(richness_df, aes(x = Chao1, y = sample_depth)) +
  geom_point(aes(color = run_date)) +
  geom_smooth(method='lm',formula=y~x) 

p2 <- ggplot(richness_df, aes(x = Observed, y = sample_depth)) +
  geom_point(aes(color = run_date)) +
  geom_smooth(method='lm',formula=y~x)
# Looking at log10 data does not change the structure

p3 <- ggplot(richness_df, aes(x = Shannon, y = sample_depth)) +
  geom_point(aes(color = run_date))  +
  geom_smooth(method='lm',formula=y~x)

p4 <- ggplot(richness_df, aes(x = Simpson, y = sample_depth)) +
  geom_point(aes(color = location)) +
  geom_smooth(method='lm',formula=y~x)

p5 <- ggplot(richness_df %>%
               rownames_to_column() %>%
               filter(rowname != "Rassnas140417"),
             aes(x = Simpson, y = sample_depth)) +
  geom_point(aes(color = location)) +
  geom_smooth(method='lm',formula=y~x)

grid.arrange(p1,p2)
ggsave(plot = grid.arrange(p3,p5), filename = "../../analysis_images/1_shannon_Simpson_outlier_rem_scatter.png")
p5


# To test for difference dependent on rarefaction 

# df_rare <- # Rarefy the data using rng-seed without replacing sampled ASVs
#   rarefy_even_depth(df,
#                     sample.size = min(sample_sums(df)),
#                     rngseed = 2018,
#                     replace = FALSE,
#                     trimOTUs = TRUE,
#                     verbose = TRUE)
# 
# richness_df_rare <- 
#   estimate_richness(df_rare,
#                     split = TRUE, # Calculate for all samples an not for each group
#                     measures = c("Observed", "Chao1", "Simpson", "Shannon")) # The measurments which are caluclated
# 
# richness_df_rare <- # Merge the alpha-div measurments with metadat
#   cbind(richness_df_rare, df@sam_data)
# 
# richness_df_rare$sample_depth <- df_rare@otu_table %>% colSums() # Add depth to metadata, for each sample
# 
# # Since we have rarefied and thus reduced the correaltion to 0 we need to look at bocplots to investigate the between sample variation, and how it changes with rarefaction
# 
# p1 <- ggplot(richness_df, aes(y = Chao1, x = run_date)) + geom_boxplot()  + theme(axis.title.x = element_blank())
# p2 <- ggplot(richness_df, aes(y = Observed, x = run_date)) + geom_boxplot() + theme(axis.title.x = element_blank())
# p3 <- ggplot(richness_df, aes(y = Shannon, x = run_date)) + geom_boxplot()  + theme(axis.title.x = element_blank())
# 
# p4 <- ggplot(richness_df_rare, aes(y = Chao1, x = run_date)) + geom_boxplot()  + theme(axis.title.x = element_blank())
# p5 <- ggplot(richness_df_rare, aes(y = Observed, x = run_date)) + geom_boxplot() + theme(axis.title.x = element_blank())
# p6 <- ggplot(richness_df_rare, aes(y = Shannon, x = run_date)) + geom_boxplot() + theme(axis.title.x = element_blank()) 
# 
# grid.arrange(p1,p4, ncol = 1)
# grid.arrange(p2,p5, ncol = 1)
# grid.arrange(p3,p6, ncol = 1)

```
### Conclusion
The diveristy indecies Observed and Chao1 seems to show a stong correlation with sequence_depth and thus exhibit a strong batch effec, this is not the case for shannon diversity. Rarefying the count-table before calulating alpha diversity does not effect the variation between the sequence runs in a big way for Chao1 and Shannon, but does for Observed (Richness). **Rarefying befor calculating alpha-idv is not recommended!**



### Alpha diversity minnesgardet, overby
Next we want to do the same analysis for Overby and Minnesgardet
```{r}
df <- # Keep samples based on location 
  prune_samples(df@sam_data$location == "Östersund" | df@sam_data$location == "Trollhättan" , df)  

df <- # Remove taxa not existing in theses samples
  prune_taxa(taxa_sums(df@otu_table) != 0, df)

richness_df <- 
  estimate_richness(df,
                    split = TRUE,
                    measures = c("Observed", "Chao1", "Shannon", "Simpson" ))

richness_df <- 
  cbind(richness_df, df@sam_data)

```

```{r}
# Here we plot the longitudinal scatterplots, shwoing the change of the index over time
# One line both for Östersund and Trollhättan are showing with color indicating the season

p4 <- 
  ggplot(richness_df, aes(x = sampling_date, y = Simpson, group = location)) +
  geom_line(aes(linetype = location, group = location)) +
  ggtitle("Simpson index") +
  geom_point(aes(group = season, color = season)) +
  theme(axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        axis.text.x =  element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 10),
        legend.title = element_blank(),
        legend.key = element_blank(),
        legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5)); p4
      
p5 <- 
  ggplot(richness_df, aes(x = sampling_date, y = Shannon, group = location)) +
  geom_line(aes(linetype = location, group = location)) +
  geom_point(aes(group = season, color = season)) +
  ggtitle("Shannon index") + 
  theme(axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        axis.text.x =  element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 10),
        legend.title = element_blank(),
        legend.key = element_blank(),
        legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5)); p5

ggsave(plot = p4, filename = "../../analysis_images/1_simpson_line_two.png")
ggsave(plot = p5, filename = "../../analysis_images/1_shannon_line_two.png")
```





